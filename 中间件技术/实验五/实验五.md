# 实验五：消息中间件和响应式编程

>实验内容：把厦门市的道路路网进行可视化展现（基于前端 HTML 页面）；并能展现汽车移动。厦门市路网和各路段的速度可见附件文件（厦门 Dimacs.zip）。  


## 第一步：定义实体类

　　自定义三个实体类，分别表示 点（Point）、线（Line）、图（Graph）。
```java
public class Point {
    Long id;
    double lon;
    double lat;

    public Point(Long id, double lon, double lat){
        this.id = id;
        this.lon = lon;
        this.lat = lat;
    }
}
```

```java
public class Line {
    Long start;
    Long end;
    double len;
    double v;

    public Line(Long start, Long end, double len, double v) {
        this.start = start;
        this.end = end;
        this.len = len;
        this.v = v;
    }
}
```

```java
public class Graph {
    ArrayList<Point> points = new ArrayList<>();
    ArrayList<Line> lines = new ArrayList<>();

    public void addPoint(Point point){
        this.points.add(point);
    }

    public void addLine(Line line){
        this.lines.add(line);
    }
}
```

<br>

## 第二步：从附件文件中读取厦门图信息
　　这里注意需要把经纬度转换为平面二维坐标系的 X、Y 坐标。定义一个 Transform 类进行转换。
```java
public class Transform {

    public double[] GetGPSToXY(double lon, double lat)
    {
        double L = 6381372 * Math.PI * 2;//地球周长
        double W=L;// 平面展开后，x轴等于周长
        double H=L/2;// y轴约等于周长一半
        double mill=2.3;// 米勒投影中的一个常数，范围大约在正负2.3之间
        double x = lon * Math.PI / 180;// 将经度从度数转换为弧度
        double y = lat * Math.PI / 180;// 将纬度从度数转换为弧度
        y=1.25 * Math.log( Math.tan( 0.25 * Math.PI + 0.4 * y ) );// 米勒投影的转换
        // 弧度转为实际距离
        x = ( W / 2 ) + ( W / (2 * Math.PI) ) * x;
        y = ( H / 2 ) - ( H / ( 2 * mill ) ) * y;
        double[] result=new double[2];
        result[0]=x;
        result[1]=y;
        return result;

    }
}

```

　　读取 `xiamenGraph.txt` 文件，实例化 graph 对象。
```java
public Graph readGraph(){
    Graph graph = new Graph();
    /* 读取数据 */
    String pathname = System.getProperty("user.dir") + "\\src\\main\\resources\\xiamenGraph.txt";
    try (FileReader reader = new FileReader(pathname);
        BufferedReader br = new BufferedReader(reader) // 建立一个对象，它把文件内容转成计算机能读懂的语言
    ) {
        String line;
        //网友推荐更加简洁的写法
        while ((line = br.readLine()) != null) {
            // 一次读入一行数据
            String []arr = line.split(" ");
            if(arr[0].equals("n")){
                Transform transform = new Transform();
                Double lon = Double.parseDouble(arr[2]);
                Double lat = Double.parseDouble(arr[3]);
                double XY[] = transform.GetGPSToXY(lon,lat);
                Point point = new Point(Long.parseLong(arr[1]),XY[0],XY[1]);
                graph.addPoint(point);
            }else if(arr[0].equals("e")){
                Line line1 = new Line(Long.parseLong(arr[1]),Long.parseLong(arr[2]),Double.parseDouble(arr[3]),Double.parseDouble(arr[4]));
                graph.addLine(line1);
            }
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
    return graph;
}
```

<br>

## 第三步：生成订单，并读取订单信息
```java
public ArrayList<Order> readOrder(){
    ArrayList<Order> orders = new ArrayList<>();
    /* 读取数据 */
    String pathname = System.getProperty("user.dir") + "\\src\\main\\resources\\qxod.txt";
    try (FileReader reader = new FileReader(pathname);
        BufferedReader br = new BufferedReader(reader) // 建立一个对象，它把文件内容转成计算机能读懂的语言
    ) {
        String line;
        //网友推荐更加简洁的写法
        while ((line = br.readLine()) != null) {
            // 一次读入一行数据
            String []arr = line.split("#");

            Transform transform = new Transform();
            Double startX = Double.parseDouble(arr[0]);
            Double startY = Double.parseDouble(arr[1]);
            double startXY[] = transform.GetGPSToXY(startX,startY);
            Double endX = Double.parseDouble(arr[2]);
            Double endY = Double.parseDouble(arr[3]);
            double endXY[] = transform.GetGPSToXY(endX,endY);
            Order order = new Order(startXY[0],startXY[1],endXY[0],endXY[1]);

            orders.add(order);
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
    return orders;
}
```

## 第四步：增加 Controller，做成 WebApplication ，提供 Web Service

```java
@RestController
public class Controller {

    @RequestMapping(value = "/graph",method = RequestMethod.GET)
    public Graph getGraph() throws Exception{
        Service service = new Service();
        return service.readGraph();
    }

    @RequestMapping(value = "/order",method = RequestMethod.GET)
    public ArrayList<Order> getOrder() throws Exception{
        Service service = new Service();
        return service.readOrder();
    }
}
```

<br>

## 第五步：构建前端系统，显示图和订单
　　编写前端代码，绘制图和订单，显示配送动画效果
　　
<div align="center">
  <img src="https://github.com/TanYJie/Technology-Stack/blob/master/中间件技术/实验四/image/权限不足.png"/>
</div>
 <div align="center">
  <img src="https://github.com/TanYJie/Technology-Stack/blob/master/中间件技术/实验四/image/删除失败.png"/>
</div>
 
