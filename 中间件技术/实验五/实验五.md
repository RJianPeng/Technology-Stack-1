# 实验五：消息中间件和响应式编程

>实验内容：把厦门市的道路路网进行可视化展现（基于前端 HTML 页面）；并能展现汽车移动。厦门市路网和各路段的速度可见附件文件（厦门 Dimacs.zip）。  


# 第一步：定义实体类

　　自定义三个实体类，分别表示 点（Point）、线（Line）、图（Graph）。
```java
public class Point {
    Long id;
    double lon;
    double lat;

    public Point(Long id, double lon, double lat){
        this.id = id;
        this.lon = lon;
        this.lat = lat;
    }
}
```

```java
public class Line {
    Long start;
    Long end;
    double len;
    double v;

    public Line(Long start, Long end, double len, double v) {
        this.start = start;
        this.end = end;
        this.len = len;
        this.v = v;
    }
}
```

```java
public class Graph {
    ArrayList<Point> points = new ArrayList<>();
    ArrayList<Line> lines = new ArrayList<>();

    public void addPoint(Point point){
        this.points.add(point);
    }

    public void addLine(Line line){
        this.lines.add(line);
    }
}
```

<br>

# 第二步：从附件文件中读取厦门图信息
　　这里注意需要把经纬度转换为平面二维坐标系的 X、Y 坐标。定义一个 Transform 类进行转换。
```java
public class Transform {

    public double[] GetGPSToXY(double lon, double lat)
    {
        double L = 6381372 * Math.PI * 2;//地球周长
        double W=L;// 平面展开后，x轴等于周长
        double H=L/2;// y轴约等于周长一半
        double mill=2.3;// 米勒投影中的一个常数，范围大约在正负2.3之间
        double x = lon * Math.PI / 180;// 将经度从度数转换为弧度
        double y = lat * Math.PI / 180;// 将纬度从度数转换为弧度
        y=1.25 * Math.log( Math.tan( 0.25 * Math.PI + 0.4 * y ) );// 米勒投影的转换
        // 弧度转为实际距离
        x = ( W / 2 ) + ( W / (2 * Math.PI) ) * x;
        y = ( H / 2 ) - ( H / ( 2 * mill ) ) * y;
        double[] result=new double[2];
        result[0]=x;
        result[1]=y;
        return result;

    }
}

```

```java
public Graph readGraph(){
    Graph graph = new Graph();
    /* 读取数据 */
    String pathname = System.getProperty("user.dir") + "\\src\\main\\resources\\xiamenGraph.txt";
    try (FileReader reader = new FileReader(pathname);
        BufferedReader br = new BufferedReader(reader) // 建立一个对象，它把文件内容转成计算机能读懂的语言
    ) {
        String line;
        //网友推荐更加简洁的写法
        while ((line = br.readLine()) != null) {
            // 一次读入一行数据
            String []arr = line.split(" ");
            if(arr[0].equals("n")){
                Transform transform = new Transform();
                Double lon = Double.parseDouble(arr[2]);
                Double lat = Double.parseDouble(arr[3]);
                double XY[] = transform.GetGPSToXY(lon,lat);
                Point point = new Point(Long.parseLong(arr[1]),XY[0],XY[1]);
                graph.addPoint(point);
            }else if(arr[0].equals("e")){
                Line line1 = new Line(Long.parseLong(arr[1]),Long.parseLong(arr[2]),Double.parseDouble(arr[3]),Double.parseDouble(arr[4]));
                graph.addLine(line1);
            }
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
    return graph;
}
```

<br>

# 第三步：定义 Pointcut，用 AOP 对 Controller 层进行增强
　　定义三个切点，分别为用 `@Read`、`@Update`、`@Aggregate` 注解的方法，定义 `@Before` 检查 HttpServletRequest 中 cookie 中的权限信息，若权限不符，则将 HttpServletResponse 的状态码设为 403，表示没有权限访问。

　　这时别忘了在 Controller 层的每个方法前加入对应的 Annotation

<br>

# 第四步：在前端做 axios 拦截器
　　我们不想在每个 ajax 请求中都加入这样的代码：
```javascript
if(JSON.parse(JSON.stringify(error)).response.status === 403){
    alert("没有权限!")
}
```
　　因此，我们使用 axios 的拦截器，自动拦截返回状态码为 403 的 response，而对成功的请求，正常处理。因此封装了一个 `handler.js`：
```javascript
import axios from "axios";

const handler = axios.create({
    baseURL: 'http://localhost:8081/',  // api的base_url
    timeout: 5000,  // 请求超时时间
    withCredentials: true
});

handler.interceptors.response.use(
    response => {  // 成功请求到数据
        return response;
    },
    error => {     // 响应错误处理
        if(JSON.parse(JSON.stringify(error)).response.status === 403){
            alert("没有权限!"); // 当然，这里也可以执行“将页面跳转到错误页面”
        }
        return Promise.reject(error);
    }
);

export default handler;
```
　　在 Vue 的 `main.js` 中进行赋值就可行了：
```javascript
import handler from './axios/handler'
Vue.prototype.$axios = handler;
```

　　权限不符时，就会自动弹窗：
<div align="center">
  <img src="https://github.com/TanYJie/Technology-Stack/blob/master/中间件技术/实验四/image/权限不足.png"/>
</div>
 <div align="center">
  <img src="https://github.com/TanYJie/Technology-Stack/blob/master/中间件技术/实验四/image/删除失败.png"/>
</div>
 
